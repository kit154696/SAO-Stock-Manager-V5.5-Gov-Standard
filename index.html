<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏∏‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡∏≠‡∏õ‡∏ó. (‡∏ß 1095)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --border: #e0e0e0;
            --sidebar-width: 260px;
        }
        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Sarabun', sans-serif; margin: 0; background: var(--bg-body); 
            color: #333; display: flex; height: 100vh; overflow: hidden;
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: var(--sidebar-width); background: var(--primary); color: white;
            display: flex; flex-direction: column; transition: 0.3s; z-index: 100;
        }
        .sidebar-brand { padding: 20px; text-align: center; background: rgba(0,0,0,0.1); }
        .sidebar-brand h2 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .sidebar-brand p { margin: 5px 0 0; font-size: 0.8rem; opacity: 0.7; }
        
        .nav-menu { flex: 1; padding: 10px; overflow-y: auto; }
        .nav-item {
            padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 6px;
            display: flex; align-items: center; gap: 10px; color: #ecf0f1; transition: 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header {
            background: white; padding: 15px 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .content-body { flex: 1; padding: 25px; overflow-y: auto; }

        /* --- COMPONENTS --- */
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-title { margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--primary); }

        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn:hover { filter: brightness(0.9); transform: translateY(-1px); }

        .form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; }
        .form-control:focus { border-color: var(--accent); }

        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover td { background: #fafafa; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .badge { padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .badge-in { background: #e8f5e9; color: #2e7d32; }
        .badge-out { background: #ffebee; color: #c62828; }

        /* --- DASHBOARD STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; color: white; }
        .stat-info h4 { margin: 0; font-size: 0.9rem; color: #777; font-weight: 400; }
        .stat-info .val { font-size: 1.5rem; font-weight: 700; color: #333; margin-top: 5px; }

        /* --- SECTIONS --- */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PRINT MODAL & SETTINGS --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 210mm; height: 90vh; overflow-y: auto; padding: 20px; border-radius: 8px; position: relative; }
        .print-preview { background: white; padding: 10mm 15mm; min-height: 297mm; }

        /* --- PRINT CSS (A4 Standard) --- */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; height: auto; overflow: visible; display: block; }
            .sidebar, .header, .no-print, .btn, .card-header button { display: none !important; }
            .content-body, .main-content { padding: 0; margin: 0; overflow: visible; }
            .modal { position: static; background: white; display: block; height: auto; }
            .modal-content { width: 100%; height: auto; padding: 0; box-shadow: none; border: none; overflow: visible; }
            .print-preview { padding: 0; margin: 0; min-height: auto; }
            table, th, td { border: 1px solid black !important; font-size: 12pt; }
            th { background: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
            .card { box-shadow: none; border: none; padding: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .header { padding: 10px 15px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <h2>üì¶ e-Stock ‡∏≠‡∏õ‡∏ó.</h2>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏∏‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡∏ß.1095</p>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            <div class="nav-item" onclick="nav('transaction', this)"><i class="fas fa-file-invoice"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢</div>
            <div class="nav-item" onclick="nav('master', this)"><i class="fas fa-cubes"></i> ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏</div>
            <div class="nav-item" onclick="nav('report', this)"><i class="fas fa-print"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <hr style="border-color:rgba(255,255,255,0.1)">
            <div class="nav-item" onclick="backupData()"><i class="fas fa-download"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <div class="nav-item" onclick="document.getElementById('fileRestore').click()"><i class="fas fa-upload"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <input type="file" id="fileRestore" hidden onchange="restoreData(this)">
        </div>
    </nav>

    <div class="main-content">
        <div class="header">
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="btn btn-secondary" onclick="toggleSidebar()" style="display:none;" id="btnMenu"><i class="fas fa-bars"></i></button>
                <h3 id="pageTitle" style="margin:0;">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h3>
            </div>
            <div>
                <span style="font-size:0.9rem; color:#777;"><i class="fas fa-building"></i> <span id="orgNameDisplay">...</span></span>
            </div>
        </div>

        <div class="content-body">
            
            <div id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--accent);"><i class="fas fa-box-open"></i></div>
                        <div class="stat-info"><h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏</h4><div class="val" id="d-totalItems">0</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--success);"><i class="fas fa-coins"></i></div>
                        <div class="stat-info"><h4>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á</h4><div class="val" id="d-totalValue">0</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--warning);"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-info"><h4>‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Low)</h4><div class="val" id="d-lowStock">0</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--danger);"><i class="fas fa-file-export"></i></div>
                        <div class="stat-info"><h4>‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</h4><div class="val" id="d-totalDocs">0</div></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="card" style="flex:2;">
                        <div class="card-header"><h3 class="card-title">‡∏Å‡∏£‡∏≤‡∏ü‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3></div>
                        <canvas id="catChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="card" style="flex:1;">
                        <div class="card-header"><h3 class="card-title">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h3></div>
                        <div style="overflow-x:auto;">
                            <table id="lowStockTable">
                                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>Min</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="transaction" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢)</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <select id="txType" class="form-control" onchange="toggleTxMode()">
                                <option value="OUT">üî¥ ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (OUT)</option>
                                <option value="IN">üü¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö/‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            <input type="date" id="txDate" class="form-control" onchange="genDocNo()">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            <input type="text" id="txDocNo" class="form-control" readonly placeholder="Auto Gen...">
                        </div>
                        <div class="form-group">
                            <label id="lblRef">‡πÄ‡∏ö‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ (‡∏Å‡∏≠‡∏á/‡∏ù‡πà‡∏≤‡∏¢)</label>
                            <input type="text" id="txRef" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <input type="text" id="txNote" class="form-control">
                    </div>

                    <div style="background:#f8f9fa; padding:15px; border-radius:6px; margin-top:15px; border:1px dashed #ccc;">
                        <div class="form-row" style="align-items: flex-end;">
                            <div class="form-group" style="flex:3;">
                                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)</label>
                                <input type="text" list="dlItems" id="cartItemInput" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onchange="selectCartItem()">
                                <datalist id="dlItems"></datalist>
                                <input type="hidden" id="cartItemId">
                            </div>
                            <div class="form-group">
                                <label>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label>
                                <input type="text" id="cartBal" class="form-control" readonly style="background:#eee;">
                            </div>
                            <div class="form-group">
                                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                                <input type="number" id="cartQty" class="form-control" min="1" value="1">
                            </div>
                            <div class="form-group" id="grpPrice" style="display:none;">
                                <label>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                <input type="number" id="cartPrice" class="form-control" min="0" step="0.01">
                            </div>
                            <div class="form-group" style="flex:0;">
                                <button class="btn btn-primary" onclick="addToCart()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <table id="cartTable">
                            <thead><tr><th>#</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="text-center">‡∏•‡∏ö</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn btn-success" onclick="saveTransaction()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3 class="card-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3></div>
                    <div style="overflow-x:auto;">
                        <table id="txHistoryTable">
                            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="master" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üì¶ ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3>
                        <button class="btn btn-primary btn-sm" onclick="openMasterModal()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div class="form-row">
                        <input type="text" id="searchMaster" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏..." onkeyup="renderMaster()">
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="masterTable">
                            <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Spec)</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="report" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üñ®Ô∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                    </div>
                    <div class="form-row" style="align-items:flex-end;">
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</label>
                            <input type="text" id="orgNameInput" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•...">
                        </div>
                        <div class="form-group">
                            <label>‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="repDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="genReport()"><i class="fas fa-search"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                        </div>
                    </div>
                    <div id="reportResult" style="margin-top:20px;">
                        </div>
                </div>
            </div>

        </div>
    </div>

    <div id="masterModal" class="modal">
        <div class="modal-content" style="width: 500px; height: auto;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3>
                <span onclick="closeModal('masterModal')" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <form onsubmit="saveMaster(event)">
                <input type="hidden" id="mId">
                <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏</label><input type="text" id="mCode" class="form-control" required></div>
                <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏</label><input type="text" id="mName" class="form-control" required></div>
                <div class="form-group"><label>‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞ (Spec)</label><input type="text" id="mSpec" class="form-control"></div>
                <div class="form-group"><label>‡∏´‡∏°‡∏ß‡∏î (‡∏ß.1095)</label>
                    <select id="mCat" class="form-control">
                        <option>1. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option><option>2. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏</option><option>3. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</option>
                        <option>4. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</option><option>5. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏™‡πà‡∏á</option><option>6. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏•‡πà‡∏≠‡∏•‡∏∑‡πà‡∏ô</option>
                        <option>7. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå/‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>8. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£</option><option>9. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
                        <option>10. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢</option><option>11. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏µ‡∏¨‡∏≤</option><option>12. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</option>
                        <option>13. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option><option>19. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∑‡πà‡∏ô</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label><input type="text" id="mUnit" class="form-control" required></div>
                    <div class="form-group"><label>‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Min)</label><input type="number" id="mMin" class="form-control" value="0"></div>
                </div>
                <div class="form-group"><label>‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</label><input type="text" id="mLoc" class="form-control"></div>
                <button type="submit" class="btn btn-success" style="width:100%; margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <div class="no-print" style="padding:10px; background:#eee; display:flex; justify-content:space-between; border-bottom:1px solid #ddd;">
                <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå</strong>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                    <button class="btn btn-danger btn-sm" onclick="closeModal('printModal')">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            <div id="printArea" class="print-preview"></div>
        </div>
    </div>

<script>
    // --- 1. DATA STORE & INIT ---
    let DB = { items: [], tx: [] };
    let cart = []; // Temp lines for transaction

    window.onload = () => {
        loadDB();
        if(window.innerWidth <= 768) document.getElementById('btnMenu').style.display = 'block';
        document.getElementById('txDate').valueAsDate = new Date();
        document.getElementById('repDate').valueAsDate = new Date();
        renderDashboard();
    };

    function saveDB() { localStorage.setItem('LAO_STOCK_DB', JSON.stringify(DB)); }
    function loadDB() {
        const d = localStorage.getItem('LAO_STOCK_DB');
        if(d) DB = JSON.parse(d);
        else seedData();
        
        const org = localStorage.getItem('OrgName');
        if(org) document.getElementById('orgNameInput').value = org;
        updateOrgDisplay();
    }
    
    function seedData() {
        // Initial Demo Data
        DB.items = [
            { id: 1, code: '001', name: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4', spec: '80g Double A', cat: '1. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', unit: '‡∏£‡∏µ‡∏°', min: 10, loc: '‡∏ï‡∏π‡πâ 1', lastPrice: 125 },
            { id: 2, code: '002', name: '‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡∏•‡∏π‡∏Å‡∏•‡∏∑‡πà‡∏ô', spec: '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô 0.5', cat: '1. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', unit: '‡∏î‡πâ‡∏≤‡∏°', min: 20, loc: '‡∏ï‡∏π‡πâ 1', lastPrice: 5 },
            { id: 3, code: 'COMP-01', name: '‡∏´‡∏°‡∏∂‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå', spec: 'HP 680 Black', cat: '12. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', unit: '‡∏ï‡∏•‡∏±‡∏ö', min: 2, loc: '‡∏ï‡∏π‡πâ 2', lastPrice: 450 }
        ];
        // Initial Balance (Opener)
        DB.tx = [
            { id: 100, docNo: '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤', date: '2025-10-01', type: 'IN', ref: '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°', note: '-', lines: [
                { itemId: 1, qty: 50, price: 125 }, { itemId: 2, qty: 100, price: 5 }, { itemId: 3, qty: 5, price: 450 }
            ]}
        ];
        saveDB();
    }

    // --- 2. CORE LOGIC ---
    function getFiscalYear(dateStr) {
        const d = new Date(dateStr);
        return (d.getMonth() + 1) >= 10 ? d.getFullYear() + 543 + 1 : d.getFullYear() + 543;
    }

    function getBal(itemId) {
        let bal = 0;
        DB.tx.forEach(t => {
            t.lines.forEach(l => {
                if(l.itemId == itemId) {
                    if(t.type === 'IN') bal += parseFloat(l.qty);
                    else bal -= parseFloat(l.qty);
                }
            });
        });
        return bal;
    }

    // --- 3. NAVIGATION ---
    function nav(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        
        if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
        
        // Refresh specific sections
        if(id === 'dashboard') renderDashboard();
        if(id === 'master') renderMaster();
        if(id === 'transaction') {
            document.getElementById('txDate').valueAsDate = new Date();
            cart = []; renderCart(); genDocNo(); updateDataList(); renderTxHistory();
        }
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    // --- 4. MASTER DATA ---
    function renderMaster() {
        const tbody = document.querySelector('#masterTable tbody');
        tbody.innerHTML = '';
        const key = document.getElementById('searchMaster').value.toLowerCase();
        
        DB.items.filter(i => i.name.toLowerCase().includes(key) || i.code.toLowerCase().includes(key)).forEach(i => {
            tbody.innerHTML += `
                <tr>
                    <td>${i.code}</td>
                    <td><b>${i.name}</b><br><small class="text-muted">${i.spec}</small></td>
                    <td>${i.cat}</td>
                    <td>${i.unit}</td>
                    <td class="text-center" style="font-weight:bold; color:${getBal(i.id)<=i.min?'red':'green'}">${getBal(i.id)}</td>
                    <td class="text-right">${i.lastPrice}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick='editMaster(${JSON.stringify(i)})'><i class="fas fa-edit"></i></button>
                        <button class="btn btn-primary btn-sm" onclick="printStockCard(${i.id})"><i class="fas fa-file-alt"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    function openMasterModal() {
        document.getElementById('mId').value = '';
        document.getElementById('mCode').value = '';
        document.getElementById('mName').value = '';
        document.getElementById('mSpec').value = '';
        document.getElementById('mUnit').value = '';
        document.getElementById('masterModal').classList.add('active');
    }

    function editMaster(item) {
        document.getElementById('mId').value = item.id;
        document.getElementById('mCode').value = item.code;
        document.getElementById('mName').value = item.name;
        document.getElementById('mSpec').value = item.spec;
        document.getElementById('mCat').value = item.cat;
        document.getElementById('mUnit').value = item.unit;
        document.getElementById('mMin').value = item.min;
        document.getElementById('mLoc').value = item.loc;
        document.getElementById('masterModal').classList.add('active');
    }

    function saveMaster(e) {
        e.preventDefault();
        const id = document.getElementById('mId').value;
        const item = {
            id: id ? parseInt(id) : Date.now(),
            code: document.getElementById('mCode').value,
            name: document.getElementById('mName').value,
            spec: document.getElementById('mSpec').value,
            cat: document.getElementById('mCat').value,
            unit: document.getElementById('mUnit').value,
            min: parseInt(document.getElementById('mMin').value) || 0,
            loc: document.getElementById('mLoc').value,
            lastPrice: 0 // Keep old price if edit, else 0
        };
        
        if(id) {
            const idx = DB.items.findIndex(x => x.id == id);
            item.lastPrice = DB.items[idx].lastPrice;
            DB.items[idx] = item;
        } else {
            DB.items.push(item);
        }
        saveDB();
        closeModal('masterModal');
        renderMaster();
    }

    // --- 5. TRANSACTION ---
    function updateDataList() {
        const dl = document.getElementById('dlItems');
        dl.innerHTML = DB.items.map(i => `<option value="${i.code} : ${i.name}">[${i.spec}] ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${getBal(i.id)} ${i.unit}</option>`).join('');
    }

    function toggleTxMode() {
        const type = document.getElementById('txType').value;
        document.getElementById('grpPrice').style.display = type === 'IN' ? 'block' : 'none';
        document.getElementById('lblRef').innerText = type === 'IN' ? '‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å (‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)' : '‡πÄ‡∏ö‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ (‡∏Å‡∏≠‡∏á/‡∏ù‡πà‡∏≤‡∏¢)';
        genDocNo();
    }

    function genDocNo() {
        const type = document.getElementById('txType').value;
        const date = document.getElementById('txDate').value;
        const fy = getFiscalYear(date);
        const fyShort = fy.toString().substr(2);
        
        // Count documents in this FY of this type
        const count = DB.tx.filter(t => t.type === type && getFiscalYear(t.date) === fy).length + 1;
        const run = count.toString().padStart(4, '0');
        document.getElementById('txDocNo').value = `${type}-${run}/${fyShort}`;
    }

    function selectCartItem() {
        const val = document.getElementById('cartItemInput').value;
        const code = val.split(':')[0].trim();
        const item = DB.items.find(i => i.code === code);
        if(item) {
            document.getElementById('cartItemId').value = item.id;
            document.getElementById('cartBal').value = `${getBal(item.id)} ${item.unit}`;
            document.getElementById('cartPrice').value = item.lastPrice;
            if(document.getElementById('txType').value === 'OUT') document.getElementById('cartQty').max = getBal(item.id);
        }
    }

    function addToCart() {
        const itemId = document.getElementById('cartItemId').value;
        const qty = parseFloat(document.getElementById('cartQty').value);
        const price = parseFloat(document.getElementById('cartPrice').value) || 0;
        const item = DB.items.find(i => i.id == itemId);

        if(!item) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏");
        if(qty <= 0) return alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");

        // Validate OUT stock
        if(document.getElementById('txType').value === 'OUT') {
            const currentBal = getBal(item.id);
            const inCart = cart.filter(c => c.itemId == itemId).reduce((a,b)=>a+b.qty, 0);
            if((qty + inCart) > currentBal) return alert("‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢");
        }

        cart.push({ itemId: item.id, name: item.name, spec: item.spec, unit: item.unit, qty, price });
        renderCart();
        document.getElementById('cartItemInput').value = '';
        document.getElementById('cartItemId').value = '';
        document.getElementById('cartQty').value = 1;
    }

    function renderCart() {
        const tb = document.querySelector('#cartTable tbody');
        tb.innerHTML = '';
        cart.forEach((c, i) => {
            tb.innerHTML += `
                <tr>
                    <td>${i+1}</td><td>${DB.items.find(x=>x.id==c.itemId).code}</td>
                    <td>${c.name} <small>${c.spec}</small></td>
                    <td class="text-center">${c.qty} ${c.unit}</td>
                    <td class="text-right">${c.price}</td>
                    <td class="text-center"><button class="btn btn-danger btn-sm" onclick="cart.splice(${i},1);renderCart();">&times;</button></td>
                </tr>`;
        });
    }

    function saveTransaction() {
        if(cart.length === 0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£");
        
        const type = document.getElementById('txType').value;
        
        // Update Prices for IN
        if(type === 'IN') {
            cart.forEach(c => {
                const item = DB.items.find(i => i.id == c.itemId);
                item.lastPrice = c.price; 
            });
        }

        const tx = {
            id: Date.now(),
            date: document.getElementById('txDate').value,
            type: type,
            docNo: document.getElementById('txDocNo').value,
            ref: document.getElementById('txRef').value,
            note: document.getElementById('txNote').value,
            lines: [...cart]
        };

        DB.tx.push(tx);
        saveDB();
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        
        // If OUT, Print automatically? Let's ask.
        if(type === 'OUT') {
            if(confirm("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) printWithdrawSlip(tx.id);
        }

        nav('transaction'); // Reset form
    }

    function renderTxHistory() {
        const tb = document.querySelector('#txHistoryTable tbody');
        tb.innerHTML = '';
        DB.tx.slice().reverse().slice(0, 10).forEach(t => {
            tb.innerHTML += `
                <tr>
                    <td>${fmtDate(t.date)}</td>
                    <td>${t.docNo}</td>
                    <td><span class="badge ${t.type==='IN'?'badge-in':'badge-out'}">${t.type}</span></td>
                    <td>${t.ref}</td>
                    <td>${t.lines.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="printWithdrawSlip(${t.id})"><i class="fas fa-print"></i></button>
                    </td>
                </tr>`;
        });
    }

    // --- 6. PRINT & REPORTS ---
    function updateOrgDisplay() {
        const org = document.getElementById('orgNameInput').value;
        document.getElementById('orgNameDisplay').innerText = org || "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô...";
        localStorage.setItem('OrgName', org);
    }

    function genReport() {
        updateOrgDisplay();
        const dateLimit = document.getElementById('repDate').value;
        const tbody = `
            <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                <thead>
                    <tr>
                        <th style="border:1px solid black; padding:8px;">‡∏ó‡∏µ‡πà</th>
                        <th style="border:1px solid black; padding:8px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th style="border:1px solid black; padding:8px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞</th>
                        <th style="border:1px solid black; padding:8px; text-align:center;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th style="border:1px solid black; padding:8px; text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th style="border:1px solid black; padding:8px; text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        <th style="border:1px solid black; padding:8px; text-align:right;">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                    </tr>
                </thead>
                <tbody>
                    ${DB.items.sort((a,b)=>a.cat.localeCompare(b.cat)).map((item, idx) => {
                        // Calculate balance as of dateLimit
                        let bal = 0;
                        DB.tx.filter(t => t.date <= dateLimit).forEach(t => {
                            t.lines.forEach(l => {
                                if(l.itemId == item.id) {
                                    if(t.type === 'IN') bal += parseFloat(l.qty);
                                    else bal -= parseFloat(l.qty);
                                }
                            });
                        });
                        if(bal <= 0) return '';
                        return `
                        <tr>
                            <td style="border:1px solid black; text-align:center;">${idx+1}</td>
                            <td style="border:1px solid black;">${item.cat}</td>
                            <td style="border:1px solid black;">${item.name} (${item.spec})</td>
                            <td style="border:1px solid black; text-align:center;">${item.unit}</td>
                            <td style="border:1px solid black; text-align:right;">${item.lastPrice.toLocaleString()}</td>
                            <td style="border:1px solid black; text-align:right;">${bal.toLocaleString()}</td>
                            <td style="border:1px solid black; text-align:right;">${(bal*item.lastPrice).toLocaleString()}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        `;

        document.getElementById('reportResult').innerHTML = tbody;
        
        // Reuse modal for print view
        const org = document.getElementById('orgNameInput').value;
        const html = `
            <div style="text-align:center">
                <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                <h4>${org}</h4>
                <p>‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${fmtDate(dateLimit)}</p>
            </div>
            ${tbody}
            <div style="margin-top:20px; text-align:right;">
                <p>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö .......................................................</p>
            </div>
        `;
        document.getElementById('printArea').innerHTML = html;
        document.getElementById('printModal').classList.add('active');
    }

    function printWithdrawSlip(txId) {
        const tx = DB.tx.find(t => t.id === txId);
        const org = document.getElementById('orgNameInput').value;
        
        const rows = tx.lines.map((l, i) => `
            <tr>
                <td style="text-align:center; padding:10px;">${i+1}</td>
                <td style="padding:10px;">${DB.items.find(x=>x.id==l.itemId).name} (${l.spec})</td>
                <td style="text-align:center; padding:10px;">${l.qty}</td>
                <td style="text-align:center; padding:10px;">${l.unit}</td>
                <td style="padding:10px;"></td>
            </tr>
        `).join('');

        const html = `
            <div style="position:relative; margin-bottom:20px;">
                <h2 style="text-align:center;">‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏</h2>
                <div style="position:absolute; top:0; right:0; text-align:right; font-size:14px;">
                    ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${tx.docNo}<br>
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${fmtDate(tx.date)}
                </div>
            </div>
            <p style="font-size:16px;"><b>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b> ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏</p>
            <p style="text-indent:40px; font-size:16px;">
                ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ <b>${tx.ref}</b> ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏î‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ
            </p>
            <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                <thead>
                    <tr>
                        <th style="width:10%; border:1px solid black;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th style="width:40%; border:1px solid black;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th style="width:15%; border:1px solid black;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
                        <th style="width:15%; border:1px solid black;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                        <th style="width:20%; border:1px solid black;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            
            <div style="display:flex; justify-content:space-between; margin-top:50px;">
                <div style="text-align:center; width:45%;">
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..............................................‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å<br>
                    (..............................................)<br>
                    ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..........................................
                </div>
                <div style="text-align:center; width:45%;">
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..............................................‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏à‡πà‡∏≤‡∏¢<br>
                    (..............................................)<br>
                    ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..........................................
                </div>
            </div>
        `;
        document.getElementById('printArea').innerHTML = html;
        document.getElementById('printModal').classList.add('active');
    }

    function printStockCard(itemId) {
        const item = DB.items.find(i => i.id === itemId);
        const org = document.getElementById('orgNameInput').value;
        const sortedTx = DB.tx.filter(t => t.lines.some(l => l.itemId === itemId))
                         .sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let bal = 0;
        const rows = sortedTx.map(t => {
            const line = t.lines.find(l => l.itemId === itemId);
            if(t.type === 'IN') bal += line.qty; else bal -= line.qty;
            
            return `
            <tr>
                <td style="text-align:center;">${fmtDate(t.date)}</td>
                <td>${t.type==='IN'?'‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å '+t.ref : '‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ '+t.ref}</td>
                <td style="text-align:center;">${t.docNo}</td>
                <td style="text-align:right;">${line.price > 0 ? line.price : '-'}</td>
                <td style="text-align:center;">${t.type==='IN' ? line.qty : '-'}</td>
                <td style="text-align:center;">${t.type==='OUT' ? line.qty : '-'}</td>
                <td style="text-align:center; font-weight:bold;">${bal}</td>
                <td>${t.note || ''}</td>
            </tr>`;
        }).join('');

        const html = `
             <div style="text-align:center; margin-bottom:20px;">
                <h3>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3>
                <div>${org}</div>
            </div>
            <div style="display:flex; justify-content:space-between; border:1px solid black; padding:10px; margin-bottom:10px;">
                <div style="line-height:1.8;">
                    <div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ${item.cat}</div>
                    <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏:</b> ${item.name}</div>
                    <div><b>‡∏Ç‡∏ô‡∏≤‡∏î/‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞:</b> ${item.spec}</div>
                </div>
                <div style="line-height:1.8; text-align:right;">
                    <div><b>‡∏£‡∏´‡∏±‡∏™:</b> ${item.code}</div>
                    <div><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö:</b> ${item.unit}</div>
                    <div><b>‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö:</b> ${item.loc}</div>
                    <div><b>‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</b> ${item.min}</div>
                </div>
            </div>
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                    <tr>
                        <th rowspan="2" style="border:1px solid black;">‡∏ß/‡∏î/‡∏õ</th>
                        <th rowspan="2" style="border:1px solid black;">‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å / ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</th>
                        <th rowspan="2" style="border:1px solid black;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                        <th rowspan="2" style="border:1px solid black;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th colspan="3" style="border:1px solid black;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th rowspan="2" style="border:1px solid black;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    </tr>
                    <tr>
                        <th style="border:1px solid black;">‡∏£‡∏±‡∏ö</th>
                        <th style="border:1px solid black;">‡∏à‡πà‡∏≤‡∏¢</th>
                        <th style="border:1px solid black;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        document.getElementById('printArea').innerHTML = html;
        document.getElementById('printModal').classList.add('active');
    }

    // --- 7. DASHBOARD & HELPERS ---
    function renderDashboard() {
        // Simple Chart
        const catCount = {};
        let totalVal = 0;
        let lowItems = 0;

        DB.items.forEach(i => {
            const bal = getBal(i.id);
            const val = bal * i.lastPrice;
            totalVal += val;
            if(bal <= i.min) lowItems++;
            
            catCount[i.cat] = (catCount[i.cat] || 0) + 1;
        });

        document.getElementById('d-totalItems').innerText = DB.items.length;
        document.getElementById('d-totalValue').innerText = totalVal.toLocaleString();
        document.getElementById('d-lowStock').innerText = lowItems;
        document.getElementById('d-totalDocs').innerText = DB.tx.filter(t => getFiscalYear(t.date) === getFiscalYear(new Date())).length;

        // Chart
        const ctx = document.getElementById('catChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(catCount).map(k => k.split('.')[1] || k),
                datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', data: Object.values(catCount), backgroundColor: '#3498db' }]
            }
        });

        // Low Stock Table
        const lowTable = document.querySelector('#lowStockTable tbody');
        lowTable.innerHTML = DB.items.filter(i => getBal(i.id) <= i.min).map(i => `
            <tr><td>${i.name}</td><td style="color:red;font-weight:bold;">${getBal(i.id)}</td><td>${i.min}</td></tr>
        `).join('');
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function fmtDate(d) { const date = new Date(d); return `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()+543}`; }
    
    function backupData() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
        a.download = `sao_stock_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }
    function restoreData(input) {
        const r = new FileReader();
        r.onload = e => { DB = JSON.parse(e.target.result); saveDB(); location.reload(); };
        r.readAsText(input.files[0]);
    }
</script>
</body>
</html>
