<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ 1-Stop Service (อปท.)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #0277bd; /* Thai Official Blue tone */
            --primary-dark: #01579b;
            --accent: #fdd835;
            --bg: #f5f7fa;
            --text: #333;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: var(--sidebar-width); background: #fff; display: flex; flex-direction: column; border-right: 1px solid #ddd; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .brand { padding: 20px; background: var(--primary); color: white; text-align: center; }
        .brand h2 { margin: 0; font-size: 1.4rem; }
        .brand p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }
        
        .menu-list { flex: 1; overflow-y: auto; padding: 10px; }
        .menu-item { 
            display: flex; align-items: center; padding: 12px 15px; 
            margin-bottom: 5px; border-radius: 8px; cursor: pointer; 
            color: #555; transition: 0.2s; text-decoration: none;
        }
        .menu-item:hover { background: #e3f2fd; color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(2,119,189,0.2); }
        .menu-item i { width: 30px; font-size: 1.1rem; text-align: center; margin-right: 10px; }

        /* --- Main Area --- */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .top-bar { background: white; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-dark); }
        
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 1-Stop Grid Menu --- */
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .grid-btn { 
            background: white; border: 1px solid #e0e0e0; border-radius: 12px; 
            padding: 30px 20px; text-align: center; cursor: pointer; 
            transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .grid-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--primary); }
        .grid-btn i { font-size: 3rem; color: var(--primary); }
        .grid-btn span { font-size: 1.1rem; font-weight: 600; color: #444; }

        /* --- Forms & Tables --- */
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: 'Sarabun'; font-size: 1rem; }
        input:focus { border-color: var(--primary); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-family: 'Sarabun'; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #43a047; color: white; }
        .btn-danger { background: #e53935; color: white; }
        .btn-warning { background: #fb8c00; color: white; }
        .btn-excel { background: #1d6f42; color: white; } /* Excel Green */
        .btn:hover { filter: brightness(0.95); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f0f0f0; padding: 10px; text-align: left; border: 1px solid #ddd; font-weight: 600; white-space: nowrap; }
        td { padding: 10px; border: 1px solid #ddd; }
        tr:nth-child(even) { background: #fafafa; }

        /* --- Modal & Print --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 95%; max-width: 297mm; height: 90vh; border-radius: 8px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .print-area { flex: 1; padding: 20px; overflow: auto; background: #888; }
        .paper { background: white; width: 297mm; min-height: 210mm; margin: 0 auto; padding: 15mm; box-shadow: 0 0 10px rgba(0,0,0,0.3); } /* A4 Landscape */

        /* --- Print CSS --- */
        @media print {
            @page { size: landscape; margin: 0; }
            body * { visibility: hidden; }
            .modal { position: absolute; inset: 0; background: white; display: block !important; }
            .modal-content { box-shadow: none; width: 100%; height: auto; }
            .modal-header, .no-print { display: none !important; }
            .print-area { background: white; padding: 0; margin: 0; overflow: visible; }
            .paper { box-shadow: none; padding: 10mm; width: 100%; margin: 0; }
            .paper * { visibility: visible; }
            
            table, th, td { border: 1px solid black !important; border-collapse: collapse; font-size: 11pt; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
        }

        /* --- Specific Print Table Styles --- */
        .doc-header { text-align: center; margin-bottom: 20px; line-height: 1.4; }
        .doc-title { font-size: 18pt; font-weight: bold; }
        .doc-info { display: flex; justify-content: space-between; font-size: 12pt; margin-bottom: 10px; }
        
        .stock-table th { text-align: center; padding: 5px; }
        .stock-table td { padding: 5px; vertical-align: top; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <h2>1-Stop Service</h2>
            <p>ระบบบริหารงาน อปท.</p>
        </div>
        <div class="menu-list">
            <div class="menu-item active" onclick="goHome()"><i class="fas fa-th"></i> หน้าจอหลัก</div>
            <div class="menu-item" onclick="nav('stock')"><i class="fas fa-boxes"></i> บัญชีคุมวัสดุ</div>
            <div class="menu-item" onclick="alert('อยู่ในระหว่างพัฒนา')"><i class="fas fa-file-invoice-dollar"></i> แนวทางการตั้งหนี้</div>
            <div class="menu-item" onclick="alert('อยู่ในระหว่างพัฒนา')"><i class="fas fa-money-check-alt"></i> การจัดทำเช็ค</div>
            <div class="menu-item" onclick="alert('อยู่ในระหว่างพัฒนา')"><i class="fas fa-hand-holding-usd"></i> การยืมเงิน</div>
            <div class="menu-item" onclick="alert('อยู่ในระหว่างพัฒนา')"><i class="fas fa-donate"></i> การรับเงิน</div>
            <div class="menu-item" onclick="alert('อยู่ในระหว่างพัฒนา')"><i class="fas fa-car-side"></i> แบบเดินทางไปราชการ</div>
            <div class="menu-item" onclick="alert('อยู่ในระหว่างพัฒนา')"><i class="fas fa-file-contract"></i> แบบฎีกา</div>
            <div class="menu-item" onclick="alert('อยู่ในระหว่างพัฒนา')"><i class="fas fa-coins"></i> การกันเงิน</div>
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div class="page-title" id="pageTitle">หน้าจอหลัก</div>
            <div>
                <button class="btn btn-warning" onclick="backupData()"><i class="fas fa-download"></i> Backup</button>
                <button class="btn btn-danger" onclick="resetData()"><i class="fas fa-sync"></i> Reset</button>
            </div>
        </div>

        <div class="content">
            
            <div id="home" class="section active">
                <div class="grid-menu">
                    <div class="grid-btn" onclick="nav('stock')">
                        <i class="fas fa-boxes"></i>
                        <span>1. บัญชีคุมวัสดุ</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบตั้งหนี้')">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>2. แนวทางการตั้งหนี้</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบเช็ค')">
                        <i class="fas fa-money-check-alt"></i>
                        <span>3. การจัดทำเช็ค</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบยืมเงิน')">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span>4. การยืมเงิน</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบรับเงิน')">
                        <i class="fas fa-donate"></i>
                        <span>5. การรับเงิน</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบเดินทาง')">
                        <i class="fas fa-car-side"></i>
                        <span>6. แบบเดินทางไปราชการ</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบฎีกา')">
                        <i class="fas fa-file-contract"></i>
                        <span>7. แบบฎีกา</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบกันเงิน')">
                        <i class="fas fa-coins"></i>
                        <span>8. การกันเงิน (ก่อหนี้)</span>
                    </div>
                    <div class="grid-btn" onclick="alert('ระบบกันเงิน')">
                        <i class="fas fa-piggy-bank"></i>
                        <span>9. การกันเงิน (ไม่ก่อหนี้)</span>
                    </div>
                </div>
            </div>

            <div id="stock" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-cogs"></i> จัดการงานวัสดุ</h3>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="nav('transaction')"><i class="fas fa-exchange-alt"></i> 1. รับเข้า - จ่ายออก</button>
                        <button class="btn btn-primary" onclick="nav('master')"><i class="fas fa-list"></i> 2. ทะเบียนคุมวัสดุ</button>
                        <button class="btn btn-primary" onclick="nav('report')"><i class="fas fa-chart-bar"></i> 3. รายงานคงเหลือ</button>
                    </div>
                    <hr>
                    <h4><i class="fas fa-history"></i> รายการล่าสุด</h4>
                    <table class="table">
                        <thead><tr><th>วันที่</th><th>เลขที่</th><th>ประเภท</th><th>รายการ</th><th>ผู้ทำรายการ</th><th>พิมพ์</th></tr></thead>
                        <tbody id="lastTxTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="master" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-plus-circle"></i> ทะเบียนคุมวัสดุ (เพิ่ม/แก้ไข)</h3>
                        <button class="btn btn-secondary" onclick="nav('stock')"><i class="fas fa-arrow-left"></i> กลับ</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>รหัสวัสดุ</label><input type="text" id="mCode"></div>
                        <div class="form-group flex-2"><label>ชื่อวัสดุ</label><input type="text" id="mName"></div>
                        <div class="form-group"><label>หน่วยนับ</label><input type="text" id="mUnit"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-2"><label>ประเภท</label><select id="mCat"></select></div>
                        <div class="form-group"><label>Min (ต่ำสุด)</label><input type="number" id="mMin" value="0"></div>
                        <div class="form-group"><label>ที่เก็บ</label><input type="text" id="mLoc"></div>
                    </div>
                    <button class="btn btn-success" onclick="saveItem()">บันทึกรายการ</button>

                    <div style="margin-top:20px">
                        <input type="text" id="searchItem" placeholder="ค้นหาชื่อวัสดุ..." onkeyup="renderMasterTable()">
                    </div>
                    <table class="table">
                        <thead><tr><th>รหัส</th><th>ชื่อ</th><th>ประเภท</th><th>คงเหลือ</th><th>จัดการ</th></tr></thead>
                        <tbody id="masterTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="transaction" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-exchange-alt"></i> บันทึก รับเข้า - จ่ายออก</h3>
                        <button class="btn btn-secondary" onclick="nav('stock')"><i class="fas fa-arrow-left"></i> กลับ</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>วันที่</label><input type="date" id="txDate"></div>
                        <div class="form-group"><label>ประเภท</label>
                            <select id="txType" onchange="renderTxForm()">
                                <option value="IN">รับเข้า (ซื้อ/จ้าง)</option>
                                <option value="OUT">จ่ายออก (เบิก)</option>
                            </select>
                        </div>
                        <div class="form-group"><label>เลขที่เอกสาร</label><input type="text" id="txDocNo"></div>
                        <div class="form-group flex-2"><label id="refLabel">รับจาก (ร้านค้า/บริษัท)</label><input type="text" id="txRef"></div>
                    </div>

                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <div class="form-row align-end">
                            <div class="form-group flex-2">
                                <label>เลือกวัสดุ</label>
                                <input type="text" list="itemList" id="txItemInput" onchange="onItemSelect()">
                                <datalist id="itemList"></datalist>
                                <input type="hidden" id="txItemId">
                            </div>
                            <div class="form-group"><label>จำนวน</label><input type="number" id="txQty" value="1"></div>
                            <div class="form-group"><label>ราคา/หน่วย</label><input type="number" id="txPrice" value="0"></div>
                            <div class="form-group"><button class="btn btn-primary" onclick="addTxLine()">เพิ่ม</button></div>
                        </div>
                    </div>

                    <table class="table">
                        <thead><tr><th>#</th><th>รายการ</th><th>จำนวน</th><th>ราคา/หน่วย</th><th>รวม</th><th>ลบ</th></tr></thead>
                        <tbody id="txLineTable"></tbody>
                    </table>
                    
                    <div style="margin-top:20px; text-align:right">
                        <button class="btn btn-success" onclick="saveTransaction()"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
                    </div>
                </div>
            </div>

            <div id="report" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-alt"></i> รายงานวัสดุคงเหลือ</h3>
                        <div>
                             <button class="btn btn-excel" onclick="exportToExcel('reportTable', 'รายงานวัสดุคงเหลือ')"><i class="fas fa-file-excel"></i> Excel</button>
                             <button class="btn btn-secondary" onclick="nav('stock')"><i class="fas fa-arrow-left"></i> กลับ</button>
                        </div>
                    </div>
                    <div class="form-row align-end">
                         <div class="form-group"><label>ณ วันที่</label><input type="date" id="repDate"></div>
                         <div class="form-group"><button class="btn btn-primary" onclick="genReport()">แสดงผล</button></div>
                    </div>
                    <div id="reportPreview"></div>
                </div>
            </div>

        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ตัวอย่างก่อนพิมพ์</h3>
                <div>
                    <button class="btn btn-excel" onclick="exportModalToExcel()"><i class="fas fa-file-excel"></i> ดาวน์โหลด Excel</button>
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> พิมพ์</button>
                    <button class="btn btn-danger" onclick="closeModal()">ปิด</button>
                </div>
            </div>
            <div class="print-area">
                <div id="paper" class="paper"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        const DB_KEY = 'LAO_1STOP_DB';
        let DB = { items: [], tx: [], orgName: 'องค์การบริหารส่วนตำบลตัวอย่าง' };
        let currentLines = [];

        const CATEGORIES = [
            "วัสดุสำนักงาน", "วัสดุไฟฟ้าและวิทยุ", "วัสดุงานบ้านงานครัว", "วัสดุก่อสร้าง",
            "วัสดุยานพาหนะและขนส่ง", "วัสดุเชื้อเพลิงและหล่อลื่น", "วัสดุวิทยาศาสตร์และการแพทย์",
            "วัสดุการเกษตร", "วัสดุโฆษณาและเผยแพร่", "วัสดุเครื่องแต่งกาย", "วัสดุกีฬา",
            "วัสดุคอมพิวเตอร์", "วัสดุการศึกษา", "วัสดุสนาม", "วัสดุสำรวจ"
        ];

        // --- INIT ---
        window.onload = () => {
            loadDB();
            initUI();
            goHome();
        };

        function loadDB() {
            const d = localStorage.getItem(DB_KEY);
            if (d) DB = JSON.parse(d);
            // ถ้าไม่มีข้อมูล ให้ใช้ข้อมูลเปล่าเริ่มต้น
        }
        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(DB)); }
        
        function initUI() {
            const sel = document.getElementById('mCat');
            CATEGORIES.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                sel.appendChild(opt);
            });
            document.getElementById('txDate').valueAsDate = new Date();
            document.getElementById('repDate').valueAsDate = new Date();
        }

        // --- NAVIGATION ---
        function goHome() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('home').classList.add('active');
            document.getElementById('pageTitle').innerText = 'หน้าจอหลัก (1-Stop Service)';
        }
        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id === 'master') renderMasterTable();
            if(id === 'transaction') {
                currentLines = [];
                renderTxLines();
                updateDatalist();
                renderTxForm();
            }
            if(id === 'stock') renderLastTx();
        }
        
        // --- MASTER DATA ---
        function saveItem() {
            const item = {
                id: Date.now(),
                code: document.getElementById('mCode').value,
                name: document.getElementById('mName').value,
                unit: document.getElementById('mUnit').value,
                cat: document.getElementById('mCat').value,
                min: document.getElementById('mMin').value,
                loc: document.getElementById('mLoc').value,
                bal: 0,
                price: 0
            };
            if(!item.name) return alert('กรุณาใส่ชื่อวัสดุ');
            
            DB.items.push(item);
            saveDB();
            alert('บันทึกสำเร็จ');
            document.getElementById('mCode').value = '';
            document.getElementById('mName').value = '';
            renderMasterTable();
        }

        function renderMasterTable() {
            const tbody = document.getElementById('masterTableBody');
            tbody.innerHTML = '';
            const filter = document.getElementById('searchItem').value;
            
            DB.items.filter(i => i.name.includes(filter) || i.code.includes(filter)).forEach(i => {
                let bal = getBalance(i.id);
                tbody.innerHTML += `
                    <tr>
                        <td>${i.code}</td>
                        <td>${i.name}</td>
                        <td>${i.cat}</td>
                        <td style="color:${bal<=i.min?'red':'green'}; font-weight:bold">${bal} ${i.unit}</td>
                        <td>
                             <button class="btn btn-warning" style="padding:5px" onclick="printStockCard(${i.id})"><i class="fas fa-print"></i> บัญชี</button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- TRANSACTION ---
        function renderTxForm() {
            const type = document.getElementById('txType').value;
            document.getElementById('refLabel').innerText = type === 'IN' ? 'รับจาก (ร้านค้า)' : 'จ่ายให้ (กอง/ฝ่าย)';
        }
        
        function updateDatalist() {
            const dl = document.getElementById('itemList');
            dl.innerHTML = '';
            DB.items.forEach(i => {
                let opt = document.createElement('option');
                opt.value = `${i.code} : ${i.name}`;
                dl.appendChild(opt);
            });
        }
        
        function onItemSelect() {
            const val = document.getElementById('txItemInput').value;
            const code = val.split(':')[0].trim();
            const item = DB.items.find(i => i.code === code);
            if(item) {
                document.getElementById('txItemId').value = item.id;
                document.getElementById('txPrice').value = item.price; // Load last price
            }
        }

        function addTxLine() {
            const id = document.getElementById('txItemId').value;
            const qty = parseFloat(document.getElementById('txQty').value);
            const price = parseFloat(document.getElementById('txPrice').value);
            
            const item = DB.items.find(i => i.id == id);
            if(!item) return alert('ไม่พบวัสดุ');
            
            currentLines.push({ itemId: id, name: item.name, unit: item.unit, qty, price });
            renderTxLines();
            document.getElementById('txItemInput').value = '';
            document.getElementById('txQty').value = 1;
        }

        function renderTxLines() {
            const tb = document.getElementById('txLineTable');
            tb.innerHTML = '';
            currentLines.forEach((l, idx) => {
                tb.innerHTML += `
                    <tr>
                        <td>${idx+1}</td>
                        <td>${l.name}</td>
                        <td>${l.qty} ${l.unit}</td>
                        <td>${l.price}</td>
                        <td>${(l.qty * l.price).toFixed(2)}</td>
                        <td><button class="btn btn-danger" onclick="removeLine(${idx})">x</button></td>
                    </tr>`;
            });
        }

        function removeLine(idx) {
            currentLines.splice(idx, 1);
            renderTxLines();
        }

        function saveTransaction() {
            if(currentLines.length === 0) return alert('ไม่มีรายการ');
            const type = document.getElementById('txType').value;
            
            const tx = {
                id: Date.now(),
                date: document.getElementById('txDate').value,
                type: type,
                docNo: document.getElementById('txDocNo').value,
                ref: document.getElementById('txRef').value,
                lines: [...currentLines]
            };
            
            // Update Prices for IN
            if(type === 'IN') {
                currentLines.forEach(l => {
                    const item = DB.items.find(i => i.id == l.itemId);
                    if(item) item.price = l.price;
                });
            }

            DB.tx.push(tx);
            saveDB();
            
            if(confirm('บันทึกแล้ว ต้องการพิมพ์เอกสารหรือไม่?')) {
                if(type === 'IN') printReceive(tx);
                else printWithdraw(tx);
            }
            
            nav('stock');
        }
        
        function renderLastTx() {
            const tb = document.getElementById('lastTxTable');
            tb.innerHTML = '';
            // Show last 5
            DB.tx.slice().reverse().slice(0, 5).forEach(t => {
                tb.innerHTML += `
                    <tr>
                        <td>${fmtDate(t.date)}</td>
                        <td>${t.docNo}</td>
                        <td>${t.type}</td>
                        <td>${t.lines.length} รายการ</td>
                        <td>${t.ref}</td>
                        <td><button class="btn btn-secondary" onclick="rePrint(${t.id})"><i class="fas fa-print"></i></button></td>
                    </tr>`;
            });
        }
        
        function rePrint(id) {
            const tx = DB.tx.find(t => t.id == id);
            if(tx.type === 'IN') printReceive(tx); else printWithdraw(tx);
        }

        // --- LOGIC ---
        function getBalance(itemId) {
            let bal = 0;
            DB.tx.forEach(t => {
                t.lines.forEach(l => {
                    if(l.itemId == itemId) {
                        if(t.type === 'IN') bal += l.qty;
                        else bal -= l.qty;
                    }
                });
            });
            return bal;
        }

        function fmtDate(d) {
            if(!d) return '';
            const date = new Date(d);
            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()+543}`;
        }

        // --- PRINTING & EXPORT ---
        function closeModal() { document.getElementById('printModal').style.display = 'none'; }
        
        function printReceive(tx) {
            let rows = '';
            let total = 0;
            tx.lines.forEach((l, i) => {
                const sum = l.qty * l.price;
                total += sum;
                rows += `
                    <tr>
                        <td class="text-center">${i+1}</td>
                        <td>${l.name}</td>
                        <td class="text-center">${l.qty}</td>
                        <td class="text-right">${l.price}</td>
                        <td class="text-right">${sum.toLocaleString()}</td>
                        <td class="text-center">${l.unit}</td>
                        <td></td>
                    </tr>`;
            });
            
            const html = `
                <div class="doc-header">
                    <div class="doc-title">${DB.orgName}<br>ใบรับพัสดุ</div>
                </div>
                <div class="doc-info">
                    <div><b>ได้รับจาก:</b> ${tx.ref}</div>
                    <div><b>เลขที่:</b> ${tx.docNo} <b>วันที่:</b> ${fmtDate(tx.date)}</div>
                </div>
                <table class="stock-table" id="exportTable">
                    <thead>
                        <tr><th>ลำดับ</th><th>รายการ</th><th>จำนวนรับ</th><th>ราคา/หน่วย</th><th>รวมเงิน</th><th>หน่วยนับ</th><th>หมายเหตุ</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                    <tfoot>
                        <tr><td colspan="4" class="text-right"><b>รวมทั้งสิ้น</b></td><td class="text-right"><b>${total.toLocaleString()}</b></td><td colspan="2"></td></tr>
                    </tfoot>
                </table>
                <br>
                <table style="border:none; margin-top:30px;">
                    <tr style="background:none;">
                        <td style="border:none; text-align:center;">
                            ลงชื่อ.........................................ผู้รับพัสดุ<br>(.........................................)<br>เจ้าหน้าที่
                        </td>
                        <td style="border:none; text-align:center;">
                            ลงชื่อ.........................................<br>(.........................................)<br>หัวหน้าเจ้าหน้าที่
                        </td>
                        <td style="border:none; text-align:center;">
                            ลงชื่อ.........................................ผู้ตรวจสอบ<br>(.........................................)
                        </td>
                    </tr>
                </table>
            `;
            document.getElementById('paper').innerHTML = html;
            document.getElementById('printModal').style.display = 'flex';
        }

        function printWithdraw(tx) {
            let rows = '';
            tx.lines.forEach((l, i) => {
                rows += `
                    <tr>
                        <td class="text-center">${i+1}</td>
                        <td>${l.name}</td>
                        <td class="text-center">${l.qty}</td>
                        <td class="text-center">${l.unit}</td>
                        <td></td>
                    </tr>`;
            });

            const html = `
                <div class="doc-header">
                    <div class="doc-title">${DB.orgName}<br>ใบเบิกพัสดุ</div>
                </div>
                <div class="doc-info">
                    <div><b>เรียน หัวหน้าหน่วยงานพัสดุ</b><br>ข้าพเจ้าขอเบิกพัสดุเพื่อใช้ในงาน...................</div>
                    <div style="text-align:right"><b>เลขที่:</b> ${tx.docNo}<br><b>กอง/ฝ่าย:</b> ${tx.ref}<br><b>วันที่:</b> ${fmtDate(tx.date)}</div>
                </div>
                <table class="stock-table" id="exportTable">
                    <thead>
                        <tr><th>ลำดับ</th><th>รายการ</th><th>จำนวนเบิก</th><th>หน่วยนับ</th><th>หมายเหตุ</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                <br>
                <table style="border:none; margin-top:20px;">
                    <tr style="background:none;">
                        <td style="border:none; text-align:center; padding:20px;">
                            ลงชื่อ.........................................ผู้เบิก<br>(.........................................)
                        </td>
                        <td style="border:none; text-align:center; padding:20px;">
                            ลงชื่อ.........................................ผู้จ่าย<br>(.........................................)<br>เจ้าหน้าที่
                        </td>
                    </tr>
                    <tr style="background:none;">
                        <td style="border:none; text-align:center; padding:20px;">
                            ลงชื่อ.........................................ผู้อนุมัติ<br>(.........................................)<br>หัวหน้าเจ้าหน้าที่
                        </td>
                        <td style="border:none; text-align:center; padding:20px;">
                            ลงชื่อ.........................................ผู้ตรวจสอบ<br>(.........................................)
                        </td>
                    </tr>
                </table>
            `;
            document.getElementById('paper').innerHTML = html;
            document.getElementById('printModal').style.display = 'flex';
        }

        function printStockCard(id) {
            const item = DB.items.find(i => i.id == id);
            const txs = DB.tx.filter(t => t.lines.some(l => l.itemId == id));
            let rows = `<tr><td></td><td>ยอดยกมา</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
            let bal = 0;

            txs.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                const line = t.lines.find(l => l.itemId == id);
                if(t.type === 'IN') bal += line.qty; else bal -= line.qty;
                
                rows += `
                    <tr>
                        <td>${fmtDate(t.date)}</td>
                        <td>${t.ref}</td>
                        <td>${t.docNo}</td>
                        <td class="text-right">${t.type==='IN'?line.price:''}</td>
                        <td class="text-center">${t.type==='IN'?line.qty:''}</td>
                        <td class="text-center">${t.type==='OUT'?line.qty:''}</td>
                        <td class="text-center">${bal}</td>
                        <td></td>
                    </tr>`;
            });

            const html = `
                <div class="doc-header">
                    <div class="doc-title">บัญชีวัสดุ</div>
                    <div style="font-size:12pt; margin-top:10px;">
                        <b>ประเภท:</b> ${item.cat} <b>ชื่อวัสดุ:</b> ${item.name} <b>รหัส:</b> ${item.code}<br>
                        <b>หน่วยนับ:</b> ${item.unit} <b>ที่เก็บ:</b> ${item.loc} <b>Min:</b> ${item.min}
                    </div>
                </div>
                <table class="stock-table" id="exportTable">
                    <thead>
                        <tr>
                            <th rowspan="2">ว/ด/ป</th><th rowspan="2">รับจาก/จ่ายให้</th><th rowspan="2">เลขที่</th><th rowspan="2">ราคาต่อหน่วย</th>
                            <th colspan="3">จำนวน</th><th rowspan="2">หมายเหตุ</th>
                        </tr>
                        <tr><th>รับ</th><th>จ่าย</th><th>คงเหลือ</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            document.getElementById('paper').innerHTML = html;
            document.getElementById('printModal').style.display = 'flex';
        }

        function genReport() {
            const date = document.getElementById('repDate').value;
            // Logic to calculate balance at date... (Simplified: showing current balance)
            let rows = '';
            let totalVal = 0;
            let i = 1;
            DB.items.forEach(item => {
                let bal = getBalance(item.id);
                if(bal > 0) {
                    let sum = bal * item.price;
                    totalVal += sum;
                    rows += `
                        <tr>
                            <td class="text-center">${i++}</td>
                            <td>${item.cat}</td>
                            <td>${item.name}</td>
                            <td class="text-center">${bal}</td>
                            <td class="text-right">${item.price}</td>
                            <td class="text-right">${sum.toLocaleString()}</td>
                            <td></td>
                        </tr>`;
                }
            });

            const html = `
                <div class="doc-header">
                    <div class="doc-title">รายการวัสดุคงเหลือ (แบบ อปท.วส)</div>
                    <div>ณ วันที่ ${fmtDate(date)}</div>
                    <div>${DB.orgName}</div>
                </div>
                <table class="stock-table" id="exportTable">
                    <thead>
                        <tr><th>ลำดับ</th><th>ประเภท</th><th>รายการ</th><th>จำนวน</th><th>ราคา</th><th>รวมเงิน</th><th>หมายเหตุ</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                    <tfoot>
                        <tr><td colspan="5" class="text-center"><b>รวม</b></td><td class="text-right"><b>${totalVal.toLocaleString()}</b></td><td></td></tr>
                    </tfoot>
                </table>
                 <div style="margin-top: 30px; display: flex; justify-content: space-between; text-align: center;">
                    <div style="width: 30%">
                        <br>(ลงชื่อ)...........................................ผู้จัดทำ<br>(.................................................)<br>เจ้าหน้าที่
                    </div>
                    <div style="width: 30%">
                        <br>(ลงชื่อ)...........................................<br>(.................................................)<br>หัวหน้าเจ้าหน้าที่
                    </div>
                    <div style="width: 30%">
                        <br>(ลงชื่อ)...........................................<br>(.................................................)<br>ปลัด/นายกฯ
                    </div>
                </div>
            `;
            document.getElementById('reportPreview').innerHTML = html;
        }

        // --- EXCEL EXPORT (Simple Blob Method) ---
        function exportToExcel(tableId, filename) {
            // This function is for on-screen tables
            let table = document.getElementById('exportTable'); // Try finding specific ID first
            if(!table) {
                // If specific ID not found inside preview, try finding generic
                const preview = document.getElementById('reportPreview');
                table = preview.querySelector('table');
            }
            
            if(!table) return alert('ไม่พบตารางข้อมูล');
            
            downloadTableAsExcel(table, filename);
        }

        function exportModalToExcel() {
            // For tables inside modal
            const table = document.getElementById('paper').querySelector('table');
            if(!table) return alert('ไม่พบข้อมูลตาราง');
            downloadTableAsExcel(table, 'เอกสาร_1Stop');
        }

        function downloadTableAsExcel(table, filename) {
            let html = table.outerHTML;
            // Add BOM for UTF-8
            let blob = new Blob(['\ufeff' + html], {
                type: 'application/vnd.ms-excel'
            });
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = filename + '.xls';
            a.click();
        }

        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_1stop.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        function resetData() {
            if(confirm('ล้างข้อมูลทั้งหมด?')) { localStorage.removeItem(DB_KEY); location.reload(); }
        }
        function restoreData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                DB = JSON.parse(e.target.result);
                saveDB();
                alert('นำเข้าข้อมูลสำเร็จ');
                location.reload();
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
